<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Ficheros css de Bootstrap -->
    <link rel="stylesheet" href="css-bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="css-bootstrap/bootstrap-grid.min.css">

    <!-- Ficheros css propios -->
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/patron.css">

    <!-- Ficheros js de Bootstrap -->
    <script defer src="js-bootstrap/bootstrap.bundle.min.js"></script>

    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    

    <title>Inicio</title>
</head>
<body class="wrapper overflow-hidden">
    <!-- BARRA DE NAVEGACION -->
    <div id="container-menu"></div>

    <div class="main-content">
        <div class="container">
        <div class="contenedor">
        <div class="row row-contenedor">
            <!-- Columna Informacion -->
            <div class="col-7">
                <div class="card card-info">
                    <div class="card-body">
                        <h3 class="card-title"><!-- Aqui se rellena el titulo del patron --></h3>
                        <h6 class="card-subtitle mb-2 text-body-secondary">
                            <div class="d-flex gap-1 creador" id="creadorPatron" data-id-creador="" style="cursor:pointer;">
                                <img src="imagenes/logo-usuario.png" alt="Perfil" class="rounded-circle img-usu">
                                Nombre del Usuario
                            </div>
                        </h6>
                        <p class="card-text">Descripcion</p>
                        <div>
                            <p class="card-precio">Precio</p>
                            <a class="btn card-link" id="btnGuardar">Guardar</a>
                            <a class="btn card-link" id="btnComprarEmpezar">Comprar</a>
                        </div>
                    </div>
                </div>

                <div class="accordion" id="accordionInformacion">
                    <!-- Item 1: Informacion -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed justify-content-between" type="button" data-bs-toggle="collapse" data-bs-target="#panelInformacion" aria-expanded="false" aria-controls="panelsStayOpen-collapseOne">
                                Información
                            </button>
                        </h2>
                        <div id="panelInformacion" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <!-- Aqui se rellena la informacion -->        
                            </div>
                        </div>
                    </div>
                    <!-- Item 2: Materiales -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed justify-content-between" type="button" data-bs-toggle="collapse" data-bs-target="#panelMateriales" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
                            Materiales
                            </button>
                        </h2>
                        <div id="panelMateriales" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <!-- Aqui se rellena los materiales -->
                            </div>
                        </div>
                    </div>
                    <!-- Item 3: Abreviaturas -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed justify-content-between" type="button" data-bs-toggle="collapse" data-bs-target="#panelAbreviaturas" aria-expanded="false" aria-controls="panelsStayOpen-collapseThree">
                            Abreviaturas
                            </button>
                        </h2>
                        <div id="panelAbreviaturas" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="row">
                                    <div class="col titulo-info">
                                        <p>Abreviaturasssss</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Item 4: Reseñas -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed justify-content-between" type="button" data-bs-toggle="collapse" data-bs-target="#panelResenas" aria-expanded="false" aria-controls="panelsStayOpen-collapseThree">
                                Reseñas
                                <span class="btn btn-outline-primary btn-sm me-auto ms-3 rounded-3 btn-nueva-resenia" data-bs-toggle="modal" data-bs-target="#modalReseña" onclick="event.stopPropagation()">
                                    Añadir Reseña
                                </span>
                            </button>
                        </h2>
                        <div id="panelResenas" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <!-- Contenedor de las reseñas -->
                                <div id="contenedorReseñas" class="row gap-2 row-resenias"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Item 5: Tags -->
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed justify-content-between" type="button" data-bs-toggle="collapse" data-bs-target="#panelTags" aria-expanded="false" aria-controls="panelsStayOpen-collapseThree">
                            Tags
                            </button>
                        </h2>
                        <div id="panelTags" class="accordion-collapse collapse">
                            <div class="accordion-body">
                                <div class="div-tags gap-1">
                                    <p class="txt-tags">osito</p>                                
                                    <p class="txt-tags">fiesta</p>                                
                                    <p class="txt-tags">lana de chenilla</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- /div info -->

            <!-- Columna Fotos -->
            <div class="col">
                <!-- Imagen a la derecha -->
                <div class="div-carousel">
                    <div id="carouselFotos" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-indicators">
                        <button type="button" data-bs-target="#carouselFotos" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                        <button type="button" data-bs-target="#carouselFotos" data-bs-slide-to="1" aria-label="Slide 2"></button>
                        <button type="button" data-bs-target="#carouselFotos" data-bs-slide-to="2" aria-label="Slide 3"></button>
                        </div>
                    <div class="carousel-inner">
                        <div class="carousel-item active" data-bs-interval="10000">
                        <img src="imagenes/osito.jpg" class="d-block w-100 rounded-3" alt="...">
                        </div>
                        <div class="carousel-item" data-bs-interval="10000">
                        <img src="imagenes/osito-izquierda.png" class="d-block w-100 rounded-3" alt="...">
                        </div>
                        <div class="carousel-item" data-bs-interval="10000">
                        <img src="imagenes/osito-derecha.png" class="d-block w-100 rounded-3" alt="...">
                        </div>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carouselFotos" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carouselFotos" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                    </div>
                </div>
            </div> <!-- /div fotos -->            

        </div>
        </div>    
        </div>

        <!-- MODAL PARA FORMULARIO DE RESEÑA -->
        <div class="modal fade" id="modalReseña" tabindex="-1" aria-labelledby="modalReseñaLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalReseñaLabel">Añadir una Reseña</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <label for="imagenPatronModal" class="form-label mt-3">Imagen del Patrón (opcional)</label>
                    <input type="file" class="form-control" id="imagenPatronModal">
    
                    <label for="puntuacionModal" class="form-label mt-3">Puntuación</label>
                    <select class="form-select" id="puntuacionModal">
                        <option value="1">1 Estrella</option>
                        <option value="2">2 Estrellas</option>
                        <option value="3">3 Estrellas</option>
                        <option value="4">4 Estrellas</option>
                        <option value="5">5 Estrellas</option>
                    </select>
    
                    <label for="comentarioModal" class="form-label mt-3">Comentario (opcional)</label>
                    <textarea class="form-control" id="comentarioModal" rows="3" placeholder="Deja tu comentario aquí"></textarea>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                  <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="agregarReseñaModal">Agregar Reseña</button>
                </div>
              </div>
            </div>
        </div>
    </div>  
    <script>
        document.getElementById("agregarReseñaModal").addEventListener("click", async function () {
            // Recoger los valores del formulario
            const imagenPatron = document.getElementById("imagenPatronModal").files[0];
            const puntuacion = document.getElementById("puntuacionModal").value;
            const comentario = document.getElementById("comentarioModal").value;
            const patron = JSON.parse(localStorage.getItem("patronSeleccionado")).id;
            const usuario = JSON.parse(localStorage.getItem("usuario")).id;

            if (!puntuacion) {
                alert("Falta la puntiación. Por favor, indica un valor.");
                return;
            }

            // FormData para enviar al backend
            const formData = new FormData();
            formData.append("idPatron", patron);
            formData.append("idUsuario", usuario);
            formData.append("puntuacion", puntuacion);
            formData.append("mensaje", comentario);
            formData.append("imagen", imagenPatron);

            try {
                const response = await fetch("/api/reviews/nuevaReview", {
                    method: "POST",
                    body: formData,
                    credentials: "include"
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Error al guardar la reseña:", errorText);
                    alert("Hubo un error al guardar la reseña.");
                    return;
                }

                const nuevaReview = await response.json(); // Esperamos recibir la reseña guardada con ruta de imagen
                window.location.href = "infoPatron.html";

            } catch (error) {
                console.error("Error de red o del servidor:", error);
                alert("No se pudo guardar la reseña. Intenta de nuevo.");
            }
        });
    </script>

    <!-- Ficheros js propios -->
    <script src="js/estructuras.js">/*Para el menu y para guardar el patron seleccionado*/</script>
    <script src="js/datosPatron.js">/*Para los datos de prueba*/</script>
    <script src="js/cargaDatosInfoPatron.js">//Para cargar de datos del patron</script>
    <script>
        window.onload = async () => {
            const params = new URLSearchParams(window.location.search);
            if (params.get("status") === "success") {
                try {
                    const idPatronCompra = JSON.parse(sessionStorage.getItem("patronCompra")).id;
                    const response = await fetch(`/api/patrones/guardarComprado?idPatron=${idPatronCompra}`, {
                        method: "POST",
                        credentials: "include"
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error("Error:", response.status, errorText);
                        alert(`Error al guardar en la lista de comprados el patrón`);
                        return;
                    }
                    btnComprarEmpezar.innerText = "Empezar";
                    alert("¡Pago realizado con éxito!");
                } catch (error) {
                    console.error("Error al guardar/dejar de guardar el patrón:", error);
                    alert("Ha ocurrido un error, inténtalo de nuevo.");
                }

            } else if (params.get("status") === "failure") {
                alert("El pago ha fallado.");
            }
        }
    </script>


</body>
</html>