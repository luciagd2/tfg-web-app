<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Ficheros css de Bootstrap -->
    <link rel="stylesheet" href="css-bootstrap/bootstrap.min.css">

    <!-- Ficheros css propios -->
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/busqueda.css">

    <!-- Ficheros js de Bootstrap -->
    <script defer src="js-bootstrap/bootstrap.bundle.min.js"></script>

    <!-- Ficheros js propios -->

    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=apparel" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=toys" />

    <title>Busqueda</title>
</head>
<body class="wrapper overflow-hidden">
    <!-- BARRA DE NAVEGACION -->
    <div id="container-menu"></div>

    <div class="main-content">
      <div class="container">
        <!-- BARRA DE BUSQUEDA -->
        <nav class="navbar bg-body-tertiary barra-busqueda">
          <div class="container-fluid">
            <form class="d-flex" role="search">
              <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
              <button class="btn btn-outline-success" type="submit">Buscar</button>
              <button class="btn btn-outline-success icon-btn" type="button" data-bs-toggle="modal" data-bs-target="#modalFiltros">
                <i class="bi bi-funnel-fill"></i>
              </button>
              <!--
              <button class="btn btn-outline-success icon-btn" type="button" data-bs-toggle="modal" data-bs-target="#modalOrden">
                <i class="bi bi-sort-down"></i>
              </button>
              -->
            </form>
          </div>
        </nav>

        <!-- CONTENEDOR PARA LAS CARDS DE LOS PATRONES -->
        <div class="contenedor-cards gap-4" id="contenedor-cards"></div>
        
        <!-- MODAL FILTROS (trigger: btn filtros) -->
        <div class="modal fade" id="modalFiltros" tabindex="-1" aria-labelledby="modalFiltrosLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalFiltrosLabel">Filtros de búsqueda</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <!-- CUERPO DEL MODAL -->
              <div class="modal-body">
                <!--
                <h5 class="titulo-categoria">Categoría</h5>
                <div class="seccion-categoria">
                  <p class="d-inline-flex fila-categorias">
                    <button type="button" class="btn toggle-btn  btn-categoria" data-bs-toggle="button">
                      Ropa
                    </button>
                    <button type="button" class="btn toggle-btn btn-categoria" data-bs-toggle="button">Accesorios</button>
                  </p>
                  <p class="d-inline-flex fila-categorias ">
                    <button type="button" class="btn toggle-btn btn-categoria" data-bs-toggle="button">
                      Muñecos
                    </button>
                    <button type="button" class="btn toggle-btn  btn-categoria" data-bs-toggle="button">
                      <i class="bi bi-three-dots"></i>
                      Otros
                    </button>
                  </p>
                </div>
              -->
                <h5 class="titulo-categoria">Dificultad</h5>
                <div class="seccion-dificultad">
                  <p class="d-inline-flex fila-dificultad">
                    <button type="button" class="btn toggle-btn" data-bs-toggle="button">
                      <i class="bi bi-star"></i>
                      Principiante
                    </button>
                    <button type="button" class="btn toggle-btn" data-bs-toggle="button">
                      <i class="bi bi-star-half"></i>
                      Intermedio
                    </button>
                    <button type="button" class="btn toggle-btn" data-bs-toggle="button">
                      <i class="bi bi-star-fill"></i>
                      Avanzado
                    </button>
                  </p>
                </div>

                <h5 class="titulo-categoria">Orden</h5>
                <div class="modal-body col-filtros">
                  <div class="btn-group-vertical " role="group" aria-label="Orden por antigüedad">
                    <input type="radio" class="btn-check" name="antig" id="antig-1" autocomplete="off">
                    <label class="btn btn-filtro mb-3" for="antig-1">
                      <i class="bi bi-calendar-plus-fill"></i> Más nuevo a más antiguo
                    </label>
                    <input type="radio" class="btn-check" name="antig" id="antig-2" autocomplete="off">
                    <label class="btn btn-filtro mb-3" for="antig-2">
                      <i class="bi bi-calendar-minus-fill"></i> Más antiguo a más nuevo
                    </label>
                  </div>
                  <div class="btn-group-vertical w-100 mb-3" role="group" aria-label="Orden por antigüedad">
                    <input type="radio" class="btn-check" name="precio" id="precio-1" autocomplete="off">
                    <label class="btn btn-filtro" for="precio-1">
                      <i class="bi bi-cash-coin"></i>
                      Precio ascendente
                    </label>
                    <input type="radio" class="btn-check" name="precio" id="precio-2" autocomplete="off">
                    <label class="btn btn-filtro" for="precio-2">
                      <i class="bi bi-piggy-bank-fill"></i>
                      Gratis
                    </label>
                  </div>
                </div>
                <!-- FOOTER DEL MODAL -->
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                  <button type="button" class="btn btn-danger" id="eliminarFiltros">Eliminar Filtros</button>
                  <button type="button" class="btn btn-primary" id="aplicarFiltros">Aplicar</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- MODAL FILTROS (trigger: btn orden) -->
        <div class="modal fade" id="modalOrden" tabindex="-1" aria-labelledby="modalOrdenLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalOrdenLabel">Orden de búsqueda</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <!-- CUERPO DEL MODAL -->
              <!--
              <div class="modal-body col-filtros">
                <div class="btn-group-vertical " role="group" aria-label="Orden por antigüedad">
                  <input type="radio" class="btn-check" name="antig" id="antig-1" autocomplete="off">
                  <label class="btn btn-filtro mb-3" for="antig-1">
                    <i class="bi bi-calendar-plus-fill"></i> Más nuevo a más antiguo
                  </label>
                  <input type="radio" class="btn-check" name="antig" id="antig-2" autocomplete="off">
                  <label class="btn btn-filtro mb-3" for="antig-2">
                    <i class="bi bi-calendar-minus-fill"></i> Más antiguo a más nuevo
                  </label>
                </div>
                <div class="btn-group-vertical w-100 mb-3" role="group" aria-label="Orden por antigüedad">
                  <input type="radio" class="btn-check" name="precio" id="precio-1" autocomplete="off">
                  <label class="btn btn-filtro" for="precio-1">
                    <i class="bi bi-cash-coin"></i>
                    Precio ascendente
                  </label>
                  <input type="radio" class="btn-check" name="precio" id="precio-2" autocomplete="off">
                  <label class="btn btn-filtro" for="precio-2">
                    <i class="bi bi-piggy-bank-fill"></i>
                    Gratis
                  </label>
                </div>
              </div>
              -->
              <!-- FOOTER DEL MODAL -->
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary">Aplicar</button>
              </div>
            </div>
          </div>
        </div>

        
      </div>
    </div>

    <script src="js/estructuras.js"></script>
    <script src="js/datosPatron.js"></script>
    <script>
      //CARGA DE PATRONES PROPIOS SEGÚN ESTADO - PUBLICADO O BORRADOR
      document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("contenedor-cards");

        const cargarPatrones = (endpoint) => {
          container.innerHTML = "";

          fetch(endpoint, {
            method: "GET",
            credentials: "include"
          })
                  .then((response) => {
                    if (!response.ok) {
                      throw new Error("No se pudieron cargar los patrones");
                    }
                    return response.json();
                  })
                  .then((patrones) => {
                    patrones.forEach((patron) => {
                      const card = document.createElement("div");
                      card.id = patron.id;
                      card.className = "card position-relative";
                      card.style.width = "18rem";

                      card.innerHTML = `
                          <button class="btn btn-light boton-popover position-absolute top-0 end-0 m-1 p-1">
                            <i class="bi bi-gear-fill"></i>
                          </button>
                          <a href="infoPatron.html" class="card-patron" data-id="${patron.id}" id="card-patron-${patron.id}">
                            <img src="${patron.imagenes?.[0] || 'placeholder.jpg'}" class="card-img-top rounded-3" alt="${patron.titulo}">
                            <div class="card-body" href="infoPatron.html">
                              <div class="dificultad-titulo">
                                ${patron.dificultad === "Avanzado"
                                      ? `<i class="bi bi-star-fill"></i>`
                                      : patron.dificultad === "Intermedio"
                                              ? `<i class="bi bi-star-half"></i>`
                                              : `<i class="bi bi-star"></i>`
                                }
                                <span class="card-title text-titulo fw-bold">${patron.titulo}</span>
                              </div>
                              <span class="text-creador">${patron.creador.nombreUsuario}</span>
                              <div class="precio-fav-guardar">
                                <span class="text-precio fw-bold">${patron.precio}</span>
                                <div class="fav-guardar">
                                  <button type="button" class="btn toggle-btn-fav" data-bs-toggle="button">
                                    <i class="bi bi-heart-fill"></i>
                                  </button>
                                  ${patron.precio === "Gratis" ?
                                  `<button type="button" class="btn toggle-btn-guardar" data-bs-toggle="button">
                                      <i class="bi bi-bookmark-fill"></i>
                                  </button>`
                                  : `<button type="button" class="btn toggle-btn-comprar" data-bs-toggle="button">
                                   <i class="bi bi-cart-fill"></i>
                                   </button>`}
                                </div>
                              </div>
                            </div>
                          </a>
                        `;

                      container.appendChild(card);

                      const cardLink = card.querySelector(`#card-patron-${patron.id}`);
                      cardLink.addEventListener("click", async (e) => {
                        e.preventDefault(); // Evitamos que el navegador cambie de página automáticamente
                        try {
                          await guardarPatronSeleccionado(patron.id);
                          window.location.href = "infoPatron.html";
                        } catch (error) {
                          console.error("Error al guardar patron:", error);
                          alert("No se pudo cargar el patrón seleccionado.");
                        }
                      });
                    });
                  })
                  .catch((error) => {
                    console.error("Error cargando patrones:", error);
                    container.innerHTML = "<p>Error cargando los patrones.</p>";
                  });
        };

        const guardarPatronSeleccionado = async (patronId) => {
          try {
            const response = await fetch(`/api/patrones/encontrar?id=${patronId}`, {
              method: "GET",
              credentials: "include"
            });
            if (!response.ok) {
              const errorText = await response.text();
              console.error("Estado:", response.status);
              console.error("Respuesta:", errorText);
              alert(`Error al encontrar patrón: ${response.status}`);
              return;
            }
            const patron = await response.json();
            localStorage.setItem("patronSeleccionado", JSON.stringify(patron));
            return;
          } catch (error) {
            console.error("Error al encontrar el patrón:", error);
            alert("No se pudo encontrar el patrón. Inténtalo de nuevo.");
          }
        };

        // Cargar publicados por defecto
        cargarPatrones("/api/patrones/getAllPatronesPublicados");

        // Eventos para radio buttons
        /*
        btnBorradores.addEventListener("change", () => {
          if (btnBorradores.checked) {
            cargarPatrones("/api/patrones/patrones-tienda-borradores", true);
          }
        });

        btnPublicados.addEventListener("change", () => {
          if (btnPublicados.checked) {
            cargarPatrones("/api/patrones/patrones-tienda-publicados", false);
          }
        });
        */

        // EVENT LISTENER PARA EL BOTON DE APLICAR FILTROS/ORDEN
        const aplicarBtn = document.querySelector('#modalFiltros .btn.btn-primary');

        document.getElementById('aplicarFiltros').addEventListener('click', () => {
          // Dificultades seleccionadas
          const dificultadBtns = document.querySelectorAll('.seccion-dificultad .toggle-btn.active');
          const dificultades = Array.from(dificultadBtns).map(btn => btn.textContent.trim());

          //if (dificultades.length > 0) {
            localStorage.setItem('filtrosBusqueda', JSON.stringify(dificultades));
          //} else {
          //  localStorage.removeItem('filtrosBusqueda');
          //}

          // Orden seleccionado
          const ordenSeleccionado = [];
          if (document.getElementById("antig-1").checked) ordenSeleccionado.push("Nuevo");
          if (document.getElementById("antig-2").checked) ordenSeleccionado.push("Antiguo");
          if (document.getElementById("precio-1").checked) ordenSeleccionado.push("Pago");
          if (document.getElementById("precio-2").checked) ordenSeleccionado.push("Gratis");

          localStorage.setItem("ordenBusqueda", JSON.stringify(ordenSeleccionado));

          // Cerrar modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('modalFiltros'));
          modal.hide();

          const filtros = JSON.parse(localStorage.getItem("filtrosBusqueda")) || [];
          const orden = JSON.parse(localStorage.getItem("ordenBusqueda")) || [];
          // Si no hay filtros ni orden
          if (filtros.length === 0 && orden.length === 0) {
            cargarPatrones("/api/patrones/getAllPatronesPublicados");
            return;
          }
          // Si hay filtros u orden, cargar con filtros
          const params = new URLSearchParams();
          filtros.forEach(f => params.append("dificultad", f));
          orden.forEach(o => params.append("orden", o));

          const endpoint = `/api/patrones/getAllFiltros?${params.toString()}`;
          cargarPatrones(endpoint);
        });

        document.getElementById('eliminarFiltros').addEventListener('click', () => {
          localStorage.removeItem('filtrosBusqueda');
          localStorage.removeItem('ordenBusqueda');

          // Opcional: Limpia selección visual
          document.querySelectorAll('.toggle-btn.active').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.btn-check').forEach(input => input.checked = false);

          // Cierra el modal
          const modalElement = bootstrap.Modal.getInstance(document.getElementById('modalFiltros'));
          modalElement.hide();

          // Carga todos los patrones por defecto
          cargarPatrones("/api/patrones/getAllPatronesPublicados");
        });
      });
    </script>

</body>
</html>