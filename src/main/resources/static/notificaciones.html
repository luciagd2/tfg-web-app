<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Ficheros css de Bootstrap -->
    <link rel="stylesheet" href="css-bootstrap/bootstrap.min.css">

    <!-- Ficheros css propios -->
    <link rel="stylesheet" href="css/general.css">
    <link rel="stylesheet" href="css/notificaciones.css">

    <!-- Ficheros js de Bootstrap -->
    <script defer src="js-bootstrap/bootstrap.bundle.min.js"></script>

    <!-- Ficheros js propios -->

    <!-- Iconos -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    

    <title>Notificaciones</title>
</head>
<body class="wrapper overflow-hidden">
    <!-- BARRA DE NAVEGACION -->
    <div id="container-menu"></div>

    <div class="main-content">
        <ul class="list-group lista-notificaciones" id="listaNotificaciones"></ul>
    </div>

    <script src="js/estructuras.js"></script>
    <script>
        const plantillasNotificaciones = {
            GUARDADO: notif => `Has guardado el patrón <strong>${notif.nombrePatron}</strong> correctamente.`,
            COMPRA_EXITOSA: notif => `Tu compra del patrón <strong>${notif.nombrePatron}</strong> fue exitosa.`,
            PATRON_GRATOS: notif => `El patrón <strong>${notif.nombrePatron}</strong> que tenías en guardado ahora es gratis.`,
            CAMBIO_PRECIO: notif => `El patrón <strong>${notif.nombrePatron}</strong> que tenías en guardado ha cambiado de precio.`,
            NUEVO_PATRON_CREADOR: notif => `<strong>${notif.nombreUsuario}</strong> ha publicado un nuevo patrón.`,
            ACTUALIZADO_GUARDADO: notif => `El patrón <strong>{notif.nombrePatron}</strong> que tienes guardado ha sido actualizado por el creador.`,
            ACTUALIZADO_COMPRADO: notif => `El patrón <strong>{notif.nombrePatron}</strong> que tienes comprado ha sido actualizado por el creador.`,
            ELIMINAR_GUARDADO: notif => `El patrón <strong>{notif.nombrePatron}</strong> que tienes guardado ha sido eliminado por el creador.`,
            COMPRA_AL_CREADOR: notif => `<strong>{notif.nombreUsuario}</strong> ha comprado tu patrón <strong>{patron}</strong>`,
            GUARDADO_AL_CREADOR: notif => `<strong>{notif.nombreUsuario}</strong> ha guardado tu patrón <strong>{patron}</strong>`,
            CALIFICACION: notif => `Tu patrón <strong>${notif.nombrePatron}</strong> ha sido calificado con <strong>${notif.estrellas} estrellas</strong> por <strong>${datos.usuario}</strong>.`,
            NUEVO_SEGUIDOR: notif => `<strong>{notif.nombreUsuario}</strong> ha comenzado a seguirte.`,
        };

        function renderNotificacionesDesdeId(lista, contenedorId) {
            const contenedor = document.getElementById(contenedorId);
            contenedor.innerHTML = ''; // limpiar

            lista.forEach(({ id, datos }) => {
                const plantilla = plantillasNotificaciones[id];
                if (!plantilla) return;

                let mensaje = plantilla;
                for (const clave in datos) {
                mensaje = mensaje.replace(new RegExp(`{${clave}}`, 'g'), datos[clave]);
                }

                const li = document.createElement('li');
                li.className = 'list-group-item  mb-2';
                li.innerHTML = mensaje;
                contenedor.appendChild(li);
            });
        }

        renderNotificacionesDesdeId(notificaciones, 'listaNotificaciones');


        async function getNombrePatron(id) {
            if (!id) return null;
            const res = await fetch(`/api/patrones/${id}`);
            const data = await res.json();
            return data.nombre;
        }

        async function getNombreUsuario(id) {
            if (!id) return null;
            const res = await fetch(`/api/usuarios/${id}`);
            const data = await res.json();
            return data.nombreUsuario;
        }

        async function enriquecerNotificacion(notif) {
            if (notif.idPatronRelacionado) {
                notif.nombrePatron = await getNombrePatron(notif.idPatronRelacionado);
            }
            if (notif.idUsuarioRelacionado) {
                notif.nombreUsuario = await getNombreUsuario(notif.idUsuarioRelacionado);
            }
            return notif;
        }

        async function cargarNotificaciones(userId) {
            const res = await fetch(`/api/notificaciones/${userId}`);
            const notificaciones = await res.json();

            const contenedor = document.getElementById("listaNotificaciones");
            contenedor.innerHTML = "";

            for (const notif of notificaciones) {
                await enriquecerNotificacion(notif);

                const plantilla = plantillasNotificaciones[notif.tipo];
                if (!plantilla) continue;

                const li = document.createElement("li");
                li.className = "list-group-item mb-2";
                li.innerHTML = plantilla(notif);
                contenedor.appendChild(li);
            }
        }
        cargarNotificaciones(JSON.parse(sessionStorage.getItem("usuario")).id);

      </script>
      

</body>
</html>